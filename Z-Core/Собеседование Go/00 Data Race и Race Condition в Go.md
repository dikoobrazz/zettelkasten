2025030317:08
___
Date: 03-03-2025 | 17:08
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Data Race и Race Condition в Go

### Что такое Data Race?
#### Определение

- **Data Race** (гонка данных) — это ситуация, когда **две или более горутины одновременно обращаются к одной и той же области памяти**, причем хотя бы одно обращение — запись, и нет синхронизации между ними.
- Это низкоуровневая проблема, связанная с доступом к памяти.
#### Характеристики

- Происходит, когда:  
    1. Две горутины обращаются к одной переменной.
    2. Одна из них пишет.
    3. Нет мьютекса, канала или другого механизма синхронизации.
- Результат непредсказуем: данные могут быть испорчены из-за перекрытия операций чтения и записи.
##### Пример Data Race
```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var counter int // Общая переменная, к которой будут обращаться горутины
    var wg sync.WaitGroup

    // Запускаем 100 горутин, каждая увеличивает counter
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            counter++ // Одновременная запись без синхронизации — data race
        }()
    }

    wg.Wait()
    fmt.Println("Counter:", counter) // Ожидаем 100, но может быть меньше
}
```

- **Комментарии**:  
    - `counter` — общая переменная, к которой обращаются все горутины.
    - `counter++` — это не атомарная операция (чтение, увеличение, запись), и горутины могут перезаписать изменения друг друга.
    - Без синхронизации результат непредсказуем (например, 87 вместо 100).
  
- **Вывод**: `Counter: <число меньше 100>` из-за data race.
##### Исправление Data Race
```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var counter int      // Общая переменная
    var wg sync.WaitGroup
    var mu sync.Mutex    // Мьютекс для синхронизации

    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            mu.Lock()      // Блокируем доступ к counter
            counter++      // Теперь запись безопасна
            mu.Unlock()    // Разблокируем
        }()
    }

    wg.Wait()
    fmt.Println("Counter:", counter) // Всегда 100
}
```

- **Комментарии**:  
    - mu.Lock() и mu.Unlock() защищают counter, предотвращая одновременный доступ.
    - Теперь нет data race, результат всегда 100.

---
### Что такое Race Condition?
#### Определение
  
- **Race Condition** (состояние гонки) — это более общее понятие, описывающее ситуацию, когда **результат программы зависит от порядка выполнения** конкурентных операций (например, горутин), и этот порядок не контролируется.  
- Это логическая ошибка в программе, которая может включать data race, но не обязательно.
#### Характеристики

- Происходит, когда:  
    1. Несколько горутин выполняют операции, зависящие от последовательности.
    2. Нет гарантии порядка выполнения.
- Результат: Неверное состояние программы из-за непредсказуемого порядка.
##### Пример Race Condition
```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var wg sync.WaitGroup
    balance := 100 // Начальный баланс

    // Горутина 1: Снятие денег
    wg.Add(1)
    go func() {
        defer wg.Done()
        temp := balance      // Читаем текущий баланс
        time.Sleep(1 * time.Millisecond) // Имитация задержки
        balance = temp - 50  // Записываем новый баланс
    }()

    // Горутина 2: Пополнение денег
    wg.Add(1)
    go func() {
        defer wg.Done()
        temp := balance      // Читаем текущий баланс
        time.Sleep(1 * time.Millisecond) // Имитация задержки
        balance = temp + 30  // Записываем новый баланс
    }()

    wg.Wait()
    fmt.Println("Итоговый баланс:", balance) // Ожидаем 80, но может быть 50 или 130
}
```

- **Комментарии**:  
    - Обе горутины читают `balance` (100), делают вычисления и записывают результат.
    - Если Горутина 1 пишет последней, `balance = 50` (100 - 50).
    - Если Горутина 2 пишет последней, `balance = 130` (100 + 30).
    - Это race condition, так как порядок влияет на результат.

- **Вывод**: `Итоговый баланс: 50` или `130` — зависит от случая.
##### Исправление Race Condition
```go
package main

import (
    "fmt"
    "sync"
    "time"
)

func main() {
    var wg sync.WaitGroup
    var mu sync.Mutex // Мьютекс для синхронизации
    balance := 100    // Начальный баланс

    wg.Add(1)
    go func() {
        defer wg.Done()
        mu.Lock()              // Блокируем доступ
        temp := balance        // Читаем
        time.Sleep(1 * time.Millisecond)
        balance = temp - 50    // Изменяем
        mu.Unlock()            // Разблокируем
    }()

    wg.Add(1)
    go func() {
        defer wg.Done()
        mu.Lock()              // Блокируем доступ
        temp := balance        // Читаем
        time.Sleep(1 * time.Millisecond)
        balance = temp + 30    // Изменяем
        mu.Unlock()            // Разблокируем
    }()

    wg.Wait()
    fmt.Println("Итоговый баланс:", balance) // Теперь всегда 80
}
```

- **Комментарии**:  
    - `mu.Lock()` гарантирует, что операции чтения и записи выполняются последовательно.
    - Сначала одна горутина завершает работу (например, `-50`), затем другая (`+30`).
    - Итог всегда 80 (100 - 50 + 30), порядок не влияет.

---
### Различия между Data Race и Race Condition

|Характеристика|Data Race|Race Condition|
|---|---|---|
|**Смысл**|Проблема доступа к памяти|Проблема логики программы|
|**Условие**|Одновременный доступ + запись|Зависимость от порядка|
|**Причина**|Нет синхронизации|Нет контроля последовательности|
|**Пример**|counter++ без мьютекса|Баланс зависит от порядка|
|**Результат**|Непредсказуемые данные|Непредсказуемый итог|
|**Инструмент**|Мьютексы, атомарные операции|Синхронизация логики|

#### Ключевое

- **Data Race** — частный случай, связанный с памятью (техническая ошибка).
- **Race Condition** — более общая проблема логики, включающая data race или другие зависимости.
  
---
### Как обнаружить?

- **Data Race**: Используйте go run -race для запуска с детектором гонок.  
    - Пример вывода для первого примера:
```text
==================
WARNING: DATA RACE
Read at 0x00c0000a4010 by goroutine 7:
...
==================
```

- **Race Condition**: Требует анализа логики и тестирования с разными сценариями.
  
---
### Итог

- **Data Race**: Когда горутины одновременно пишут/читают общую память без защиты (техническая проблема).
- **Race Condition**: Когда результат зависит от непредсказуемого порядка выполнения (логическая проблема).

Синхронизация (мьютексы, каналы) решает обе проблемы.

-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
