2025030423:42
___
Date: 04-03-2025 | 23:42
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Stop-the-World (STW)

> **Stop-the-World (STW)** — это фаза работы сборщика мусора (Garbage Collector, GC) в Go (и других языках), когда выполнение программы полностью приостанавливается, чтобы GC мог безопасно проанализировать и очистить память.

---
### Что такое Stop-the-World?

#### Определение

- **STW** — это момент, когда все горутины (потоки выполнения) в программе останавливаются, чтобы сборщик мусора мог:
    1. Отметить (mark) живые объекты в памяти.
    2. Очистить (sweep) неиспользуемые объекты.
- Это необходимо, чтобы избежать конфликтов между GC и программой, которая продолжает выделять память.
#### Почему происходит?

- В Go используется **триколорный сборщик мусора** (mark-and-sweep):
    - Черные объекты: проверены и живы.
    - Серые объекты: еще не проверены, но достижимы.
    - Белые объекты: потенциальный мусор.
- STW нужен, чтобы "заморозить" состояние кучи (heap) и точно определить, какие объекты живы.
#### Когда происходит?

- Запускается, если объем выделенной памяти превышает порог (управляется GOGC, по умолчанию 100 — удвоение кучи).

---
### Как долго происходит STW в Go?

#### Длительность

- В современных версиях Go (1.5+) STW минимизирован благодаря **конкурентному сборщику мусора**:
    - **Mark-фаза**: Большая часть выполняется параллельно с программой, STW занимает только начало (отметка корней — корневых объектов, таких как глобальные переменные и стек).
    - **Sweep-фаза**: Выполняется конкурентно, STW минимален или отсутствует.
- **Типичное время STW**:
    - 10-100 микросекунд (0.01-0.1 мс) для небольших приложений.
    - До 1-10 мс для крупных приложений с большим количеством горутин и сложной кучей.
- **Факторы влияния**:
    - Размер кучи (heap): больше живых объектов — дольше STW.
    - Количество горутин: больше стеков для сканирования.
    - Частота аллокаций: быстрее заполняется куча — чаще STW.
#### Эволюция

- Go 1.5 (2015): Введение конкурентного GC, STW сократился с секунд до микросекунд.
- Go 1.19+: Оптимизации сделали STW еще короче (обычно <1 мс).

---
### Пример влияния STW
##### Код с нагрузкой
```go
package main

import (
    "fmt"
    "runtime"
    "time"
)

func main() {
    // заставляем GC работать чаще
    runtime.GOGC = 10 // триггер GC при росте кучи на 10%

    // выделяем память для увеличения кучи
    for i := 0; i < 10; i++ {
        start := time.Now()
        data := make([]byte, 10<<20) // 10 MB
        _ = data // избегаем оптимизации компилятором
        fmt.Printf("Выделение %d: %v\n", i, time.Since(start))
    }
}
```

- **Комментарий**:
    - GOGC=10 ускоряет запуск GC, STW заметен как микрозадержки в time.Since.
    - Вывод может показать паузы (например, 0.5-2 мс) во время STW.

##### Анализ с pprof
```bash
go run -cpuprofile=cpu.pprof main.go
go tool pprof cpu.pprof
(pprof) top
```

- STW виден как время, потраченное в runtime.gcBgMarkWorker или runtime.stopTheWorld.

---
### Как минимизировать STW?

1. **Уменьшить аллокации**:
    - Используйте `sync.Pool` для переиспользования объектов.
2. **Настроить GOGC**:
    - Увеличение `GOGC` (например, 200) реже запускает GC, но STW может быть дольше.
3. **Оптимизировать структуры**:
    - Меньше указателей = быстрее сканирование корней.

---
### Коротко

- **Что такое**: STW — пауза программы для работы GC.
- **Как долго**: 10-100 мкс (до 1-10 мс в сложных случаях) в Go 1.19+.
- **Зачем**: Отмечает живые объекты и очищает мусор.







-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
