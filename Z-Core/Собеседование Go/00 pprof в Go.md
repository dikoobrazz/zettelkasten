2025030422:32
___
Date: 04-03-2025 | 22:32
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## pprof в Go

> **pprof** — это инструмент в Go для профилирования производительности приложений. Он помогает анализировать, как программа использует ресурсы (CPU, память, горутины и т.д.), выявлять узкие места и оптимизировать код

---
### Что такое pprof?
#### Определение

- **pprof** — это часть стандартной библиотеки Go (`runtime/pprof` и `net/http/pprof`), основанная на Google Perf Tools, адаптированная для Go.
- Это средство для сбора и визуализации данных о производительности программы.
#### Что делает?

1. **Собирает данные**:
    - Профилирует использование CPU, памяти, блокировок, горутин.
    - Записывает "снимки" (snapshots) выполнения в определенные моменты.
2. **Анализирует**:
    - Показывает, где программа тратит время (CPU) или память (heap).
    - Выявляет функции, занимающие больше всего ресурсов.
3. **Визуализирует**:
    - Генерирует отчеты в текстовом или графическом виде (например, через `go tool pprof`).

---
### Основные типы профилей

1. **CPU Profile**:
    - Показывает, сколько времени тратится в каждой функции.
    - Полезно для поиска "горячих точек" (hot spots).
2. **Heap Profile**:
    - Показывает выделение памяти (где и сколько байт).
    - Помогает найти утечки памяти.
3. **Goroutine Profile**:
    - Показывает количество и состояние горутин.
    - Полезно для анализа конкурентности.
4. **Block Profile**:
    - Показывает время, потраченное на ожидание мьютексов.
5. **Mutex Profile**:
    - Анализирует конкуренцию за мьютексы.

---
### Как работает pprof?
#### Встроенный сбор

- Библиотека `runtime/pprof` собирает данные автоматически (например, CPU профиль включается через `StartCPUProfile`).
- Для HTTP-серверов используется `net/http/pprof`, добавляя эндпоинты (например, `/debug/pprof/`).
#### Инструмент анализа

- `go tool pprof` читает собранные данные и предоставляет интерфейс для анализа (CLI или визуализация).

---
### Пример использования

##### 1. Простой пример с CPU профилированием
```go
package main

import (
    "log"
    "os"
    "runtime/pprof"
    "time"
)

func heavyWork() {
    for i := 0; i < 1e9; i++ { // имитация нагрузки на CPU
        _ = i
    }
}

func main() {
    // создаем файл для записи CPU профиля
    f, err := os.Create("cpu.pprof")
    if err != nil {
        log.Fatal(err)
    }
    defer f.Close()

    // включаем профилирование CPU
    if err := pprof.StartCPUProfile(f); err != nil {
        log.Fatal(err)
    }
    defer pprof.StopCPUProfile() // останавливаем при выходе

    // выполняем работу
    heavyWork()
    time.Sleep(1 * time.Second) // добавляем задержку для наглядности
}
```

- **Комментарий**:
    - `StartCPUProfile` начинает запись использования CPU.
    - После выполнения создается файл `cpu.pprof`.

#### 2. Анализ профиля
##### После запуска программы:
```bash
go tool pprof cpu.pprof
```
##### В интерактивном режиме:
```text
(pprof) top
```
##### Выводит топ функций по использованию CPU:
```text
Showing nodes accounting for 1.50s, 100% of 1.50s total
   flat  flat%   sum%        cum   cum%
  1.50s   100%   100%      1.50s   100%  main.heavyWork
```
##### Графический вид:
```bash
go tool pprof -web cpu.pprof
```

- Открывает граф в браузере.

#### 3. HTTP сервер с pprof

```go
package main

import (
    "log"
    "net/http"
    _ "net/http/pprof" // регистрируем эндпоинты pprof
)

func main() {
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        for i := 0; i < 1e7; i++ { // имитация нагрузки
            _ = i
        }
        w.Write([]byte("Hello"))
    })
    log.Fatal(http.ListenAndServe(":8080", nil))
}
```

- **Комментарий**:
    - Доступ через `/debug/pprof/`:
        - `/debug/pprof/profile` — CPU профиль (30 сек).
        - `/debug/pprof/heap` — профиль памяти.
    - Запрос: `curl http://localhost:8080/debug/pprof/profile > profile.pprof`.

---
### Плюсы pprof

- Встроен в Go, не требует сторонних зависимостей.
- Подробные профили (CPU, память, горутины).
- Легкая интеграция с HTTP-серверами.
### Минусы pprof

- Требует ручного анализа (`go tool pprof`).
- Накладные расходы при включении профилирования в продакшене.
- Может быть сложно интерпретировать для новичков.

---
### Коротко

- **Что такое**: Инструмент профилирования в Go.
- **Что делает**: Собирает данные о CPU, памяти, горутинах; помогает найти узкие места.
- **Как**: Через `runtime/pprof` или `/debug/pprof`, анализируется с `go tool pprof`.


-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
