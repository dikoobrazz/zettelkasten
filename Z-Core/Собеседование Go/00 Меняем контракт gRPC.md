2025030621:19
___
Date: 06-03-2025 | 21:19
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Что можно поменять в контракте grpc чтобы ничего не сломалось?

В **gRPC** контракт определяется через `.proto` файлы с использованием Protocol Buffers. Чтобы изменить контракт без поломки совместимости, нужно следовать правилам обратной совместимости Protobuf, так как gRPC зависит от сериализации данных. Вот что можно поменять безопасно:

1. **Добавить новые поля с новыми номерами**:

- Старые клиенты и серверы просто игнорируют новые поля, а новые используют значения по умолчанию, если поля отсутствуют.
- Например, в контракте:
```go
message HelloRequest {
    string name = 1;
}
```

Можно добавить:
```go
message HelloRequest {
    string name = 1;
    int32 age = 2; // новое поле
}
```

- Старый клиент отправит только `name`, сервер увидит `age = 0`, и ничего не сломается.

2. **Пометить поля как устаревшие (deprecated)**:
    - Вместо удаления поля можно отметить его как `deprecated`, сохранив номер:
```go
message HelloRequest {
    string name = 1 [deprecated = true]; // устарело, но совместимо
    int32 age = 2;
}
```

-  Старые клиенты продолжат отправлять name, новые могут его игнорировать.

3. **Зарезервировать номера и имена (reserved)**:
    - Если поле больше не нужно, его номер резервируется, чтобы избежать повторного использования:
```go
message HelloRequest {
    reserved 1; // резервируем номер старого поля
    reserved "name"; // резервируем имя
    int32 age = 2;
}
```

- Это предотвращает конфликты в будущем.

4. **Добавить новые методы в сервис**:
	- Добавление метода в интерфейс сервиса безопасно, так как старые клиенты его не вызовут:
```go
service Greeter {
    rpc SayHello (HelloRequest) returns (HelloReply);
    rpc SayGoodbye (HelloRequest) returns (HelloReply); // новый метод
}
```

- Сервер должен реализовать новый метод, но старые клиенты продолжат работать с `SayHello`.

5. **Изменить метаданные**:
    - gRPC передает метаданные через HTTP/2 заголовки, их изменение (например, добавление нового заголовка) не ломает контракт, так как это вне Protobuf.

**Что нельзя менять**:

- Удалять поля полностью или менять их номера — старые клиенты отправят данные по старым номерам, что приведет к ошибкам.
- Менять типы полей (например, `string` на `int32`) — это нарушит десериализацию.

**Пример из практики**: В одном проекте я добавлял поле `priority` в сообщение для сортировки задач. Старые клиенты его не отправляли, сервер принимал `priority = 0` как дефолтное значение, и логика осталась рабочей. Это позволило обновить систему без остановки.

Таким образом, изменения в контракте gRPC безопасны, если добавлять новые элементы и не трогать старые номера и типы."


-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
