2025040313:49
___
Date: 03-04-2025 | 13:49
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Каналы в Go

### НЕ буферризированные каналы

> Каналы - это концепция, которая включает в себя:
> - разделение на роли (читатели, писатели)
> - любое количество участников в рамках одной роли
> - конкурентно-безопасная передача данных от писателя к читателю "из рук в руки"
> - блокирующее ожидание при отсутствии "второй стороны"
> - очереди ожидания для читателей и писателей

> Роли могут быть комбинированными, в одной комнате
> НО! сама суть канала от этого не меняется, меняется лишь принцип работы "комнаты".

- Обычный канал используется, когда передача данных между горутинами - это конечная цель коммуникации
- Канал с буфером используется, когда горутины передают друг другу служебную информацию об пределённом ограничении
- Использование канала с буфером только для передачи данных - возможно, но это лишний оверхед. Прийдётся более внимательно писать код, учитывать возможные потери данных и т.д.
- Если без буфера точно не обойтись, для потоковой передачи данных стоит использовать готовые решения типа Apache Kafka

---
### Аксиомы каналов

#### Не буфферизированный канал

|              |          **Открытый**          | **Закрытый** | **Неинициализированный** |
| ------------ | :----------------------------: | :----------: | :----------------------: |
| **Чтение**   | Блокировка до прихода писателя |  Zero Value  |   Блокировка навсегда    |
| **Запись**   | Блокировка до прихода читателя |    Panic     |   Блокировка навсегда    |
| **Закрытие** |        Канал закроется         |    Panic     |          Panic           |
#### Буфферизированный канал

|            | **Открытый и частично заполненный** | **Открытый и полностью заполненный** |     **Открытый и пустой**      | **Закрытый и частично заполненный** |
| :--------: | :---------------------------------: | :----------------------------------: | :----------------------------: | :---------------------------------: |
| **Чтение** |         Прочитаем значение          |          Прочитаем значение          | Блокировка до прихода читателя |         Прочитаем значение          |
| **Запись** |          Запишем значение           |    Блокировка до прихода читателя    |        Запишем значение        |                Panic                |

---
### Подводные камни

- Всегда инициализируй канал!
- Во избежании чтения из пустого канала (deadlock) - всегда закрывай канал (zero val)
- если при чтении из канала мы используем `for v := range ch {}` - всегда закрывай канал

##### Пример пайплана из генераторов
```go
package main

import (
	"fmt"
	"time"
)

// Написать 3 функции:
// writer - генерирует числа от 1 до 10
// doubler - умножает числа на 2, имитируя работу (500ms)
// reader - читает и выводит на экран

func writer() <-chan int {
	ch := make(chan int)

	go func() {
		for i := range 10 {
			ch <- i + 1
		}
		close(ch)
	}()

	return ch
}

func doubler(in <-chan int) <-chan int {
	ch := make(chan int)

	go func() {
		for v := range in {
			time.Sleep(500 * time.Millisecond)
			ch <- v * 2
		}
		close(ch)
	}()

	return ch
}

func reader(ch <-chan int) {
	for v := range ch {
		fmt.Println(v)
	}
}

func main() {
	reader(doubler(writer()))
}
```

---
### Буфферизированные каналы

> Канал с буфером работает как обычный канал, НО!
> - блокировка на запись - только при ПОЛНОСТЬЮ ЗАПОЛНЕННОМ БУФЕРЕ
> - блокировка на чтение - только при ПУСТОМ буфере
> - в иных случаях, блокировки нет -> СИНХРОНИЗАЦИИ тоже НЕТ

#### Когда использовать буфферизованные каналы

- Когда точно знаем , зачем нам буфер, и его размер
	(примеры паттернов: rate limiter, semaphore, worker pool, etc)


-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
