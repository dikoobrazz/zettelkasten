2025030222:11
___
Date: 02-03-2025 | 22:11
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Блокировки в базах данных

> **Блокировки в базах данных** — это механизм, который используется для управления конкурентным доступом к данным, чтобы обеспечить их целостность и согласованность при одновременной работе нескольких транзакций. Они предотвращают конфликты, такие как "грязное чтение" или "потерянное обновление".

---
### Что такое блокировки?

#### Определение

> **Блокировка** — это ограничение доступа к ресурсу (строке, таблице, странице) в базе данных, которое накладывается одной транзакцией, чтобы другие транзакции не могли одновременно изменять или читать этот ресурс в конфликтующий способ.

#### Зачем нужны?

- **Целостность**: Гарантируют, что данные остаются согласованными.
- **Изоляция**: Обеспечивают уровень изоляции транзакций (например, `REPEATABLE READ`, `SERIALIZABLE`).
- **Конфликты**: Решают проблемы конкурентного доступа.
  
---
### Типы блокировок

#### 1. По уровню ресурса

- **Блокировка строки (Row Lock)**: Только одна строка блокируется.
- **Блокировка таблицы (Table Lock)**: Вся таблица недоступна.
- **Блокировка страницы (Page Lock)**: Блок данных (например, 8 КБ в PostgreSQL).
#### 2. По типу доступа

- **Shared Lock (S)**: Разделяемая блокировка. Позволяет читать данные, но запрещает их изменять. Несколько транзакций могут держать S-блокировку одновременно.  
    - Пример: `SELECT` в режиме `REPEATABLE READ`.
- **Exclusive Lock (X)**: Исключительная блокировка. Дает полный контроль (чтение и запись), запрещает любой доступ другим транзакциям.  
    - Пример: `UPDATE`, `DELETE`.
#### 3. По времени действия

- **Краткосрочные**: Устанавливаются на время операции (например, во время `UPDATE`).
- **Долгосрочные**: Держатся до конца транзакции (например, в `SERIALIZABLE`).
  
---
### Как работают блокировки?
#### Пример в PostgreSQL

1. **Транзакция 1**:
```sql
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;
```

-  Устанавливается **X-блокировка** на строку с id = 1.

2. **Транзакция 2**:
```sql
BEGIN;
UPDATE users SET balance = balance + 50 WHERE id = 1;
```

-  Ждет, пока Транзакция 1 завершится (`COMMIT` или `ROLLBACK`), так как X-блокировка уже есть.
  
3. **Транзакция 1**:
```sql
COMMIT;
```

 - Блокировка снимается, Транзакция 2 продолжает.
#### Механизм

- База ведет **таблицу блокировок**, где фиксируются заблокированные ресурсы, типы блокировок и владельцы (транзакции).
- Если запрос конфликтует с существующей блокировкой, он либо ждет (timeout), либо откатывается (deadlock).

---
### Проблемы с блокировками

#### 1. Тупики (Deadlocks)

- Две транзакции ждут друг друга.
- Пример:  
    - Т1: `UPDATE users WHERE id = 1` (X на id=1).
    - Т2: `UPDATE users WHERE id = 2` (X на id=2).
    - Т1: `UPDATE users WHERE id = 2` (ждет Т2).
    - Т2: `UPDATE users WHERE id = 1` (ждет Т1).  
- Решение: База обнаруживает deadlock и откатывает одну транзакцию.
#### 2. Задержки

- Долгие транзакции с X-блокировками блокируют доступ, вызывая очереди.
#### 3. Избыточность

- Слишком строгие блокировки (например, на всю таблицу) снижают производительность.

---
### Уровни изоляции и блокировки

- **Read Uncommitted**: Минимум блокировок, возможны "грязные" чтения.
- **Read Committed**: S-блокировки на чтение, X на запись, краткосрочные.
- **Repeatable Read**: S-блокировки держатся до конца транзакции.
- **Serializable**: Максимальные блокировки, включая диапазоны (range locks), для полной изоляции.

---
### Как управлять блокировками?

1. **Минимизировать время транзакций**:  
    - Делайте `COMMIT` или `ROLLBACK` как можно быстрее.
2. **Использовать подходящий уровень изоляции**:  
    - `Read Committed` обычно достаточно, если не нужна строгая изоляция.
3. **Индексы**:  
    - Ускоряют операции, снижая время удержания блокировок.
4. **Явные блокировки** (если нужно):  
    - `SELECT ... FOR UPDATE`: Блокирует строки для последующего изменения.
```sql
SELECT * FROM users WHERE id = 1 FOR UPDATE;
```

5. **Мониторинг**:  
    - В PostgreSQL: `SELECT * FROM pg_locks;` для анализа текущих блокировок.

---
### Итог

**Блокировки в базах данных:**

- Управляют конкурентным доступом.
- Бывают разделяемыми (S) и исключительными (X), на строки, таблицы или страницы.
- Решают проблемы целостности, но могут вызывать тупики и задержки.
  
Используйте их осознанно, минимизируя время удержания и выбирая правильный уровень изоляции.



-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
