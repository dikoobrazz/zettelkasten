2025030221:05
___
Date: 02-03-2025 | 21:05
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Что такое notify в postgresql?

В PostgreSQL `NOTIFY` — это команда, которая используется для отправки уведомлений (сообщений) из базы данных клиентам или другим частям системы через механизм **асинхронных уведомлений**. Она работает в паре с командой `LISTEN`, позволяя реализовать модель "издатель-подписчик" (pub/sub) прямо в базе. 

---
### Что такое NOTIFY?
#### Определение

- `NOTIFY` отправляет уведомление по указанному **каналу** (имя канала — строка) с опциональной **полезной нагрузкой** (сообщением).
- Клиенты, подписанные на этот канал через `LISTEN`, получают уведомление асинхронно.
#### Синтаксис

```sql
NOTIFY канал [, 'полезная_нагрузка'];
```

- **канал**: Имя канала (например, `updates`).
- **полезная_нагрузка**: Необязательная строка (доступна с PostgreSQL 9.0).

---
### Как это работает?

1. **Отправка уведомления**:  
    - Выполняется NOTIFY в рамках транзакции (например, в триггере или запросе).
2. **Подписка**:  
    - Клиент (приложение, сессия) выполняет LISTEN канал, чтобы подписаться.
3. **Получение**:  
    - Подписчики получают уведомление (имя канала + нагрузку) после коммита транзакции.
#### Важно

- Уведомления отправляются только после `COMMIT` транзакции. Если транзакция откатывается (`ROLLBACK`), `NOTIFY` не срабатывает.
- Это асинхронный процесс: подписчики получают уведомления, когда готовы их принять.

---
### Пример
#### Таблица и триггер
```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    amount INT
);

-- Функция для уведомления
CREATE OR REPLACE FUNCTION notify_order_change()
RETURNS TRIGGER AS $$
BEGIN
    PERFORM pg_notify('order_updates', NEW.id::text);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Триггер
CREATE TRIGGER order_change_notify
AFTER INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION notify_order_change();

-- Тест
INSERT INTO orders (amount) VALUES (100);
```

- После вставки триггер отправляет уведомление на канал order_updates с id новой записи.
#### Подписка (в другой сессии)
```sql
LISTEN order_updates;
```

- Выполните в другой сессии (например, в psql).
- После `INSERT` в первой сессии вторая получит:

```text
Asynchronous notification "order_updates" with payload "1" received from server process with PID 1234.
```

---
### Когда использовать NOTIFY?

1. **Реактивные системы**:  
    - Уведомление приложений о изменениях (например, новый заказ → обновить кэш).
2. **Очереди задач**:  
    - Сигнализировать воркерам о новых заданиях (альтернатива внешним очередям вроде Redis).
3. **Мониторинг**:  
    - Логирование событий (например, аудит изменений).
4. **Координация**:  
    - Синхронизация между сервисами без polling'а (опроса базы).
#### Примеры
  
- **Чат**: Новый сообщение → NOTIFY подписчикам чата.
- **Кэш**: Обновление записи → инвалидация кэша в приложении.
  
---
### Плюсы и минусы

#### Плюсы

- Простота: встроено в PostgreSQL, не требует внешних инструментов.
- Асинхронность: уменьшает нагрузку по сравнению с опросом.
- Полезная нагрузка: можно передавать данные (до 8000 байт).
#### Минусы

- Нет гарантии доставки: если подписчик не слушает, уведомление теряется.
- Ограниченная нагрузка: только текст, до 8000 байт.
- Масштабируемость: не заменяет полноценные очереди (Kafka, RabbitMQ) для больших систем.

---
### Отличия от polling'а


- **Polling**: Приложение периодически опрашивает базу (`SELECT ... WHERE updated_at > ...`).  
    - Минус: Нагрузка на базу, задержка.  
- **NOTIFY/LISTEN**: База сама уведомляет.  
    - Плюс: Мгновенно, меньше нагрузки.

---
### Итог

`NOTIFY` в PostgreSQL — это механизм отправки асинхронных уведомлений по каналам. Используйте его для:

- Реактивных обновлений.
- Уведомлений о событиях.
- Простых очередей задач.

Он работает через `LISTEN` и триггеры, обеспечивая связь базы с приложением


-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
