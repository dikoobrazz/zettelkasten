2025030421:36
___
Date: 04-03-2025 | 21:36
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## JSONB

> **JSONB** — это тип данных в PostgreSQL, представляющий собой бинарный формат для хранения и обработки JSON (JavaScript Object Notation). Он был введен в PostgreSQL 9.4 как более эффективная альтернатива обычному типу `JSON`.

---
### Что такое JSONB?

#### Определение

- **JSONB** (JSON Binary) — это тип данных, который хранит JSON в бинарном виде, оптимизированном для быстрого доступа, поиска и индексации.
- В отличие от `JSON` (текстовый формат), `JSONB` разбирает JSON при вставке и сохраняет его в компактной форме.
#### Основные особенности

1. **Бинарное хранение**:
    - Данные хранятся в разобранном виде (не как строка), что ускоряет операции.
2. **Поддержка индексов**:
    - Можно создавать индексы (например, GIN), что делает поиск по ключам/значениям быстрым.
3. **Нет дубликатов ключей**:
    - Если в JSON есть повторяющиеся ключи, сохраняется только последнее значение (в отличие от `JSON`).
4. **Операторы**:
    - Поддерживает операции вроде `@>` (содержит), `->` (извлечение), `?` (проверка ключа).
##### Пример JSONB
```json
{
    "name": "Alice",
    "age": 30,
    "city": "New York"
}
```

В JSONB это хранится как бинарный объект, а не текст.

---
### Отличия от JSON

|Характеристика|JSON|JSONB|
|---|---|---|
|**Формат**|Текст|Бинарный|
|**Скорость вставки**|Быстрее (без парсинга)|Медленнее (парсинг при вставке)|
|**Скорость запросов**|Медленнее (парсинг при чтении)|Быстрее (разобранный формат)|
|**Индексы**|Нет (или сложнее)|Полная поддержка (GIN)|
|**Размер**|Меньше (сырой текст)|Больше (бинарный overhead)|
|**Дубликаты ключей**|Сохраняются|Последний перезаписывает|

---
### Пример использования в PostgreSQL

##### Создание таблицы
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    data JSONB
);
```

##### Вставка данных
```sql
INSERT INTO users (data) VALUES 
    ('{"name": "Alice", "age": 30, "city": "New York"}'),
    ('{"name": "Bob", "age": 25, "city": "San Francisco"}');
```

#### Запросы

1. **Поиск по ключу**:
```sql
SELECT * FROM users WHERE data->>'name' = 'Alice';
```

- `->>` извлекает значение как текст.
    - Результат: `{"name": "Alice", "age": 30, "city": "New York"}`.
    
2. **Проверка наличия**:
```sql
SELECT * FROM users WHERE data @> '{"city": "New York"}';
```

- `@>` проверяет, содержит ли JSONB указанный объект.
    - Результат: запись Alice.
    
3. **Индекс для ускорения**:
```sql
CREATE INDEX idx_users_data ON users USING GIN (data);
```

- GIN индекс ускоряет запросы вроде `@>` или `?`

---
##### Пример в Go
```go
package main

import (
    "database/sql"
    "fmt"
    _ "github.com/lib/pq"
)

func main() {
    db, err := sql.Open("postgres", "user=pguser dbname=test sslmode=disable")
    if err != nil {
        fmt.Println("Ошибка подключения:", err)
        return
    }
    defer db.Close()

    // вставка JSONB
    _, err = db.Exec(`INSERT INTO users (data) VALUES ($1)`, `{"name": "Charlie", "age": 35}`)
    if err != nil {
        fmt.Println("Ошибка вставки:", err)
        return
    }

    // запрос JSONB
    var data string
    err = db.QueryRow(`SELECT data->>'name' FROM users WHERE data @> '{"age": 35}'`).Scan(&data)
    if err != nil {
        fmt.Println("Ошибка запроса:", err)
        return
    }
    fmt.Println("Имя:", data) // Имя: Charlie
}
```

- **Комментарий**: Используем `database/sql` для работы с JSONB, извлекаем имя по условию.

---
### Когда использовать JSONB?

- **Гибкие данные**: Когда структура данных может меняться (нет фиксированной схемы).
- **Поиск**: Для запросов по ключам/значениям с индексами.
- **Микросервисы**: Хранение сложных объектов без изменения схемы.
### Когда не использовать?

- **Простые данные**: Для фиксированных полей лучше обычные столбцы (`int`, `text`).
- **Частые вставки**: `JSON` может быть быстрее из-за отсутствия парсинга.

---
### Коротко

- **JSONB**: Бинарный JSON в PostgreSQL для быстрого поиска и индексации.
- **Отличие**: Быстрее для запросов, поддерживает индексы, но чуть медленнее при вставке.
- **Применение**: Гибкие данные с частыми запросами.







-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
