2025030418:02
___
Date: 04-03-2025 | 18:02
Tags: #
mapofcontents: [[zero-links|OO Links]]
___
## Можно ли использовать несколько мьютексов в одной функции?

> Да, в Go можно использовать несколько мьютексов в одной функции, и это вполне допустимый подход, если нужно синхронизировать доступ к разным ресурсам или разделить критические секции. Однако это требует осторожности, чтобы избежать дедлоков (deadlocks) и обеспечить читаемость кода

---
### Когда использовать несколько мьютексов?

- **Разные ресурсы**: Если функция работает с несколькими независимыми данными (например, два счетчика или разные структуры).
- **Уменьшение конкуренции**: Вместо одного мьютекса на всю структуру можно использовать отдельные мьютексы для разных частей, повышая параллелизм.
#### Возможные проблемы

- **Дедлок**: Если горутины блокируют мьютексы в разном порядке (например, горутина 1: mu1 → mu2, горутина 2: mu2 → mu1).
- **Сложность**: Код становится труднее читать и поддерживать.
##### Пример кода с комментариями
```go
package main

import (
    "fmt"
    "sync"
    "time"
)

// Data — структура с двумя независимыми счетчиками
type Data struct {
    counter1 int
    counter2 int
    mu1      sync.Mutex // мьютекс для counter1
    mu2      sync.Mutex // мьютекс для counter2
}

// IncrementCounters — функция с двумя мьютексами
func (d *Data) IncrementCounters() {
    // Блокируем первый мьютекс для counter1
    d.mu1.Lock()
    defer d.mu1.Unlock() // гарантируем разблокировку
    d.counter1++         // увеличиваем первый счетчик

    // Блокируем второй мьютекс для counter2
    d.mu2.Lock()
    defer d.mu2.Unlock() // гарантируем разблокировку
    d.counter2++         // увеличиваем второй счетчик
}

func main() {
    data := Data{} // создаем экземпляр структуры
    var wg sync.WaitGroup

    // Запускаем 10 горутин для конкурентного увеличения счетчиков
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            data.IncrementCounters() // каждая горутина вызывает функцию
            time.Sleep(10 * time.Millisecond) // имитация работы
        }()
    }

    wg.Wait() // ждем завершения всех горутин
    fmt.Println("Counter1:", data.counter1) // ожидается 10
    fmt.Println("Counter2:", data.counter2) // ожидается 10
}
```

- **Вывод:**

```text
Counter1: 10
Counter2: 10
```

#### Комментарии к коду

- **Два мьютекса**: `mu1` защищает `counter1`, `mu2 — counter2`.
- **Локальная синхронизация**: Каждая критическая секция (увеличение счетчика) защищена своим мьютексом.
- **Порядок**: Внутри одной функции мьютексы блокируются всегда в одном порядке 
	(`mu1` → `mu2`), что предотвращает дедлок.
- **Параллелизм**: Если бы счетчики обновлялись независимо в разных функциях, это позволило бы параллельное выполнение.

---
##### Пример с потенциальным дедлоком
```go
package main

import (
    "fmt"
    "sync"
)

type Data struct {
    mu1, mu2 sync.Mutex
}

func main() {
    data := Data{}
    var wg sync.WaitGroup

    wg.Add(2)
    go func() { // горутина 1
        defer wg.Done()
        data.mu1.Lock()
        time.Sleep(10 * time.Millisecond) // имитация работы
        data.mu2.Lock() // пытается захватить mu2
        fmt.Println("Горутина 1")
        data.mu2.Unlock()
        data.mu1.Unlock()
    }()

    go func() { // горутина 2
        defer wg.Done()
        data.mu2.Lock()
        time.Sleep(10 * time.Millisecond) // имитация работы
        data.mu1.Lock() // пытается захватить mu1
        fmt.Println("Горутина 2")
        data.mu1.Unlock()
        data.mu2.Unlock()
    }()

    wg.Wait() // программа может зависнуть из-за дедлока
}
```

- **Комментарий**:
    - Горутина 1: `mu1 → mu2`.
    - Горутина 2: `mu2 → mu1`.
    - Это создает дедлок: каждая ждет, пока другая разблокирует свой мьютекс.

---
### Коротко

- **Можно ли?**: Да, несколько мьютексов в одной функции допустимы.
- **Зачем?**: Для защиты разных ресурсов или повышения параллелизма.
- **Как избежать проблем?**:
    - Всегда блокируйте мьютексы в одном порядке.
    - Используйте `defer` для гарантированной разблокировки.

-----
**Zero-Links**  (Внутренние ссылки) Линки - ключевые слова
-

------
**Links** (Внешние ссылки)
-
